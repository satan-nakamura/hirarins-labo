# legacyアプリ

## ざっくり仕様
### オンライン
1. 初期化処理  
    * SampleServletのロード時に初期ユーザーデータとして、user1/user2/user3のデータを登録する。  
このときのDBアクセスは、RMIでバッチプロセスへDBへの書き込み要求を出す。  

2. ログイン画面  
    * user1 - user3 パスワードはIDと一緒
    * 5回認証エラーになるとアカウントロックし、アンロックリクエスト画面へ遷移
    * 認証失敗時にエラーメッセージは何も表示しない。
    * 認証成功すると、最終ログイン日時を更新し（オンラインから直接更新）ハロー画面へ遷移。

3. アンロックリクエスト画面
    * アンロックリクエスト画面で正しいUserIDとPassでリクエストするとハロー画面へ遷移。
    * アンロックリクエストが受理されるとアンロック対象となり、別プロセスのClientによりアンロックされる。

4. ハロー画面
    * ログインユーザー名を表示する。
    * ログインユーザーがアンロックリクエスト対象の場合は、アンロックリクエストが受理された旨のメッセージを表示する。

5. その他仕様
    * オンラインよりも先にバッチプロセス（RMIRegistryとRMIServerの2つ）が起動していないとオンライン起動時にエラーが発生する。
    * オンラインのログはコンソールに出力することで、tomcatによりcatalina.logに出力される。
    * DB接続はtomcatに設定したデータソースから取得する。
    * RMIの接続先はlocalhost固定（ハードコード）で、ポートはデフォルトのRMI関連ポートを利用する。
    * フレームワークは利用していない。純粋なServlet/JSPとJDBCのみを利用。
    * ログ出力はlog4jを利用

### バッチ（RMIServer）
* RMIServer起動前にRMIRegistryが別プロセスで起動している必要あり。
* Server起動時にスタブを登録し、RMIでの接続要求を待ち受ける。
* RMIの待受ポートはデフォルトのRMI関連ポート
* DB接続は、オンラインとのコード共通化のためDataSourceから取得している。
* データソースはJNDIの仕組みに沿ってlookup可能な独自データソースを実装。（内部的にはDriverManagerで接続するだけ）
* バッチ（RMIServer）のDB接続先は、batch.propertiesで定義している。
* batchパッケージ配下のクラスが出力するログは、全てCATALINA_HOME/logs/batch.logに出力する。
* ログ出力はlog4jを利用。

### クライアント（ポーリングするやつ）
* DBアクセスはすべて、RMIでバッチプロセスへ要求を出す。
* クライアント起動前にRMIServerが起動している必要あり。
* ログの出力先はバッチ(RMIServer)のログ出力に準ずる。
